import { createServer as _tcp_server, createConnection as _tcp_connect } from 'net'
import net_common from './_net_common.jsy'

export default function tcp_plugin(plugin_options={}) ::
  const on_url_connect = plugin_options.on_url_connect
  const protocol = plugin_options.protocol || 'tcp'

  return function(hub) ::
    const plugin = Object.assign @ connect, @{}
      connect, createServer, on_url_connect, with_url_options

    const _common_ = net_common @ hub, plugin, protocol
    return hub[protocol] = plugin

    function connect(...args) ::
      return connectId(protocol, ...args)

    function createServer(onPeer) ::
      return createServerId(protocol, onPeer)

    function connectId(channel_id, ...args) ::
      return _common_.createClient @ channel_id,
        handler => _tcp_connect @ ...args, handler

    function createServerId(channel_id, onPeer) ::
      return _common_.createServer @ channel_id, onPeer,
        handler => _tcp_server @ handler

    function with_url_options(options) ::
      return this.url_options = Object.assign @
        {}, this.url_options, options
