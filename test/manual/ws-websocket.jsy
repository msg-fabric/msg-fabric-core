const WebSocket = require('ws')


import BasicHub from '../_setup'
import web_plugin from '../../cjs/plugin-web'
const WebFabricHub = BasicHub.plugin @ web_plugin()

const hub = WebFabricHub.create('$server$')

hub.local.registerTarget @ 'hello-server'
  (...args) => console.log('RECV in WS hello-server:', args)



const http = require('http')
const server = http.createServer()

server.listen @ 8000, '127.0.0.1', () =>
  console.log @ 'Listening', server.address()

const wss = new WebSocket.Server @: server
wss.on @ 'connection', (ws, req) => :: add_websocket(ws)


async function add_websocket(ws) ::
  hub.router.unregisterRoute('$browser$')

  const channel = await hub.web.connectWS(ws)
  console.log @ 'Msg-Fabric faye-websocket connected', @{}
    version: ws.version, protocol: ws.protocol
    channel, send: channel.send

  const peer_info = await channel.peer_info
  console.log('peer_info:', peer_info)
  hub.send @:
    id_route: '$browser$', id_target: 'hello-browser',
    body: @{} msg: 'hello from the WS websocket server'

