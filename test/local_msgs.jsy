import {TestDirectHub as Hub} from './_setup.jsy'

function addTarget(hub, id_target, api) ::
  const {id_route} = hub.local
  console.log()
  console.log @ 'create', @{} id_route, id_target
  const tgt = hub.msgs.as({id_route, id_target})

  hub.local.registerTarget(id_target, on_msg)
  if api.on_init ::
    Promise.resolve()
      .then @=> api.on_init(tgt)
      .catch @ console.error

  return tgt.toJSON()

  async function on_msg(pkt) ::
    try ::
      await tgt._recv_(pkt)

      if pkt.op.msgid ::
        pkt.op.resolve @ pkt.json()

      if null != api.on_msg ::
        await api.on_msg(pkt)
    catch err ::
      console.error @ err



const hub = Hub.create('hub')


const apple = addTarget @ hub, 'apple', @{}
  async on_init(tgt) ::
    console.log @ 'init apple' //, tgt, orange
    await tgt.to(orange).send @:
      msg: 'hello from Apple'

  async on_msg(pkt) ::
    console.log()
    console.log @ 'apple got', pkt, pkt.json()

    if pkt.op.from ::
      pkt.op.anon().send @:
        msg: 'zoiks!'
    else ::
      console.log @ 'no reply available', pkt, pkt._hdr_.op


const orange = addTarget @ hub, 'orange', @{}
  async on_init(tgt) ::
    console.log @ 'init orange' //, tgt, apple

  async on_msg(pkt) ::
    console.log @ 'orange got', pkt, pkt.json()

    if pkt.op.from ::
      await pkt.op.reply().send @:
        msg: 'back at ya!'
    else ::
      console.log @ 'no reply available', pkt, pkt._hdr_.op

