require('source-map-support').install()
import {packetStreamParser, packMessage} from '../dist/parser'

const psp = packetStreamParser()
const asMsg = (body, header) => packMessage @:
  id_router: 0xaaaaaaaa
  body: Buffer.from @ body
  header: Buffer.from @ header || ''

if 1 ::
  const buf = asMsg @ 'body', 'header'
  const ans = psp.parseHeader @ buf
  console.log @
  console.dir @ ans, @: colors: true, showHidden: true
  console.log @ buf.byteLength
  console.log @ buf
  console.log @

if 1 ::
  //log_complete @ 'feed:', psp.feed @ asMsg @ 'body', 'hdr.'
  let mz = @#
    asMsg @ '', ''
    asMsg @ 'A', 'BBB'
    asMsg @ 'CC', 'DDDDD'
    asMsg @ 'EEEE', 'FFFFFFFF'

  console.log @ mz.map @ e => Buffer.from(e)
  mz = Buffer.concat @ mz
  console.log @ Buffer.from @ mz
  log_complete @ 'Multiple:', psp.feed @ mz


function log_complete(prefix, complete) ::
  complete.forEach @ e => ::
    e.body = Buffer(e.sliceBody()).toString()
    e.header = Buffer(e.sliceHeader()).toString()

  console.log @ `\n${prefix}`
  console.dir @ complete, @: colors: true
  return complete

